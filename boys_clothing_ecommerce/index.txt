<?php
session_start();
require 'includes/config.php';

try {
    $stmt = $pdo->prepare("SELECT p.*, u.username FROM products p JOIN users u ON p.seller_id = u.id WHERE p.status IN ('approved', 'available')");
    $stmt->execute();
    $products = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    error_log("Database error in index.php: " . $e->getMessage(), 3, "/Applications/XAMPP/xamppfiles/htdocs/boys_clothing_ecommerce/errors.log");
    $products = [];
}
?>

<?php require 'includes/header.php'; ?>
<div class="container my-4">
    <h2 class="text-center">Welcome to Second Hand Clothes Marketplace</h2>
    <div class="row g-3">
        <?php if (empty($products)): ?>
            <p class="text-center">No products available.</p>
        <?php else: ?>
            <?php foreach ($products as $product): ?>
                <?php
                $images = json_decode($product['images'], true);
                $firstImage = !empty($images) ? htmlspecialchars($images[0]) : 'Uploads/default.jpg';
                ?>
                <div class="col-md-3">
                    <div class="card h-100">
                        <img src="<?php echo $firstImage; ?>" class="card-img-top" alt="<?php echo htmlspecialchars($product['title']); ?>">
                        <div class="card-body">
                            <h5 class="card-title"><?php echo htmlspecialchars($product['title']); ?></h5>
                            <p class="card-text"><?php echo htmlspecialchars(substr($product['description'], 0, 100)) . '...'; ?></p>
                            <p class="card-text"><strong>Price:</strong> $<?php echo number_format($product['price'], 2); ?></p>
                            <p class="card-text"><strong>Category:</strong> <?php echo htmlspecialchars($product['category']); ?></p>
                            <p class="card-text"><strong>Condition:</strong> <?php echo htmlspecialchars($product['item_condition']); ?></p>
                            <p class="card-text"><strong>Seller:</strong> <?php echo htmlspecialchars($product['username']); ?></p>
                            <a href="product.php?id=<?php echo $product['id']; ?>" class="btn btn-primary">View Details</a>
                            <?php if (isset($_SESSION['role']) && $_SESSION['role'] == 'buyer'): ?>
                                <button class="btn btn-outline-secondary wishlist-btn mt-2" data-product-id="<?php echo $product['id']; ?>">
                                    <?php
                                    $wishlistStmt = $pdo->prepare("SELECT id FROM wishlist WHERE buyer_id = ? AND product_id = ?");
                                    $wishlistStmt->execute([$_SESSION['user_id'], $product['id']]);
                                    echo $wishlistStmt->fetch() ? 'Remove from Wishlist' : 'Add to Wishlist';
                                    ?>
                                </button>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
</div>
<?php require 'includes/footer.php'; ?>